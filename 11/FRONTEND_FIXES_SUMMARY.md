# å‰ç«¯APIé—®é¢˜ä¿®å¤æ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. **AIè®¾ç½®å‚æ•°ä¼ é€’ä¿®å¤** - `lib/ai-service.ts`

**ä¿®å¤å‰çš„é—®é¢˜**:
- AIè®¾ç½®å‚æ•° `settings` è¢«å®Œå…¨å¿½ç•¥
- ç”¨æˆ·é…ç½®çš„API Keyã€æ¨¡å‹åç§°ã€æ¸©åº¦ç­‰å‚æ•°æ— æ³•ä¼ é€’ç»™åç«¯
- å‰ç«¯åªå‘é€æ–‡æœ¬å†…å®¹ï¼Œåç«¯æ— æ³•çŸ¥é“ç”¨æˆ·æƒ³ä½¿ç”¨ä»€ä¹ˆAIæ¨¡å‹

**ä¿®å¤å†…å®¹**:
```typescript
// ä¿®å¤å‰
const formData = new FormData()
formData.append("text", lastUserMessage.content)

// ä¿®å¤å  
const formData = new FormData()
formData.append("messages", JSON.stringify(messages))        // å®Œæ•´å¯¹è¯å†å²
formData.append("ai_settings", JSON.stringify(settings))     // AIé…ç½®å‚æ•°
```

**è§£å†³çš„é—®é¢˜**:
- âœ… AIè®¾ç½®å‚æ•°ç°åœ¨æ­£ç¡®ä¼ é€’ç»™åç«¯
- âœ… åç«¯å¯ä»¥è·å–ç”¨æˆ·çš„API Keyã€æ¨¡å‹é€‰æ‹©ç­‰é…ç½®
- âœ… æ”¯æŒå¤šç§AIæ¨¡å‹åˆ‡æ¢ï¼ˆOpenAIã€Claudeã€Geminiç­‰ï¼‰

---

### 2. **å¯¹è¯ä¸Šä¸‹æ–‡ä¿®å¤** - `lib/ai-service.ts`

**ä¿®å¤å‰çš„é—®é¢˜**:
- åªå‘é€æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œä¸¢å¤±å¯¹è¯å†å²
- AIæ— æ³•ç†è§£ä¸Šä¸‹æ–‡ï¼Œå½±å“å›å¤è´¨é‡

**ä¿®å¤å†…å®¹**:
```typescript
// ä¿®å¤å‰ï¼šåªå‘é€æœ€åä¸€æ¡æ¶ˆæ¯
const lastUserMessage = messages.filter((msg) => msg.role === "user").pop()
formData.append("text", lastUserMessage.content)

// ä¿®å¤åï¼šå‘é€å®Œæ•´å¯¹è¯å†å²
formData.append("messages", JSON.stringify(messages))
```

**è§£å†³çš„é—®é¢˜**:
- âœ… AIç°åœ¨å¯ä»¥è®¿é—®å®Œæ•´çš„å¯¹è¯å†å²
- âœ… æé«˜äº†å¯¹è¯çš„è¿è´¯æ€§å’Œä¸Šä¸‹æ–‡ç†è§£
- âœ… æ”¯æŒå¤šè½®å¯¹è¯å’Œå¼•ç”¨ä¹‹å‰çš„å†…å®¹

---

### 3. **ä»£ç†è¯·æ±‚ä¿®å¤** - `lib/proxy-request.ts`

**ä¿®å¤å‰çš„é—®é¢˜**:
- å¼ºåˆ¶è®¾ç½®Content-Typeå¯èƒ½è¦†ç›–multipart/form-dataçš„è¾¹ç•Œä¿¡æ¯
- ä½¿ç”¨`req.blob()`å¤„ç†FormDataä¸æ˜¯æœ€ä½³æ–¹æ¡ˆ

**ä¿®å¤å†…å®¹**:
```typescript
// ä¿®å¤å‰
headers: {
  "Content-Type": req.headers.get("content-type") || "application/json",
},
body: await req.blob(),

// ä¿®å¤å
headers: {
  ...(req.headers.get("content-type") 
      ? { "Content-Type": req.headers.get("content-type")! }
      : { "Content-Type": "application/json" }),
},
body: await req.arrayBuffer(),
```

**è§£å†³çš„é—®é¢˜**:
- âœ… æ­£ç¡®ä¿ç•™multipart/form-dataçš„è¾¹ç•Œä¿¡æ¯
- âœ… æ›´å¥½åœ°å¤„ç†å„ç§è¯·æ±‚ä½“ç±»å‹
- âœ… ä¿®å¤å›¾ç‰‡ä¸Šä¼ å¯èƒ½çš„é—®é¢˜

---

### 4. **AIè¿æ¥æµ‹è¯•ä¿®å¤** - `lib/ai-service.ts`

**ä¿®å¤å‰çš„é—®é¢˜**:
- `validateAISettings`åªæµ‹è¯•`/api/health`ç«¯ç‚¹
- æ— æ³•éªŒè¯ç”¨æˆ·çš„AIè®¾ç½®æ˜¯å¦çœŸæ­£æœ‰æ•ˆ

**ä¿®å¤å†…å®¹**:
```typescript
// ä¿®å¤å‰ï¼šåªæµ‹è¯•å¥åº·æ£€æŸ¥
const response = await fetch("/api/health", { method: "GET" })

// ä¿®å¤åï¼šæµ‹è¯•çœŸæ­£çš„AIæ¨¡å‹è¿æ¥
const response = await fetch("/api/test-ai-model", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(settings),
})
```

**è§£å†³çš„é—®é¢˜**:
- âœ… çœŸæ­£éªŒè¯AIæ¨¡å‹è¿æ¥è€Œä¸æ˜¯åªæµ‹è¯•å¥åº·æ£€æŸ¥
- âœ… ä¼ é€’ç”¨æˆ·çš„AIè®¾ç½®è¿›è¡ŒéªŒè¯
- âœ… æ›´å‡†ç¡®çš„è¿æ¥çŠ¶æ€åé¦ˆ

---

## ğŸ¯ ä¿®å¤åçš„APIè°ƒç”¨æµç¨‹

### ä¹‹å‰çš„æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰:
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
2. å‰ç«¯åªå–æœ€åä¸€æ¡æ¶ˆæ¯ âŒ
3. å¿½ç•¥æ‰€æœ‰AIè®¾ç½® âŒ
4. å‘é€åˆ°`/api/query`
5. åç«¯æ— æ³•çŸ¥é“ç”¨æˆ·æƒ³ç”¨ä»€ä¹ˆæ¨¡å‹ âŒ

### ä¿®å¤åçš„æµç¨‹ï¼ˆæ­£ç¡®ï¼‰:
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
2. å‰ç«¯æ”¶é›†å®Œæ•´å¯¹è¯å†å² âœ…
3. åŒ…å«ç”¨æˆ·çš„AIè®¾ç½®ï¼ˆAPI Keyã€æ¨¡å‹ç­‰ï¼‰ âœ…
4. å‘é€åˆ°`/api/query`ï¼š
   - `messages`: å®Œæ•´å¯¹è¯å†å²
   - `ai_settings`: AIé…ç½®å‚æ•°
   - `image`: å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
5. åç«¯å¯ä»¥ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„æ¨¡å‹å’Œé…ç½® âœ…

---

## ğŸ” æ–°çš„APIè°ƒç”¨æ ¼å¼

### æŸ¥è¯¢æ¥å£ - `POST /api/query`
```http
Content-Type: multipart/form-data

messages: JSONå­—ç¬¦ä¸²ï¼ŒåŒ…å«å®Œæ•´å¯¹è¯å†å²
ai_settings: JSONå­—ç¬¦ä¸²ï¼ŒåŒ…å«AIé…ç½®
image: æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
```

### AIè®¾ç½®éªŒè¯ - `POST /api/test-ai-model`
```http
Content-Type: application/json

{
  "baseUrl": "https://api.openai.com/v1",
  "sdk": "openai", 
  "modelName": "gpt-4o",
  "apiKey": "sk-...",
  "temperature": 0.7,
  "maxTokens": 4000
}
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•:
1. **AIè®¾ç½®æµ‹è¯•**: åœ¨è®¾ç½®ä¸­é…ç½®ä¸åŒçš„AIæ¨¡å‹ï¼ŒéªŒè¯æ˜¯å¦ç”Ÿæ•ˆ
2. **å¯¹è¯ä¸Šä¸‹æ–‡æµ‹è¯•**: è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œæ£€æŸ¥AIæ˜¯å¦è®°ä½ä¹‹å‰çš„å†…å®¹
3. **å›¾ç‰‡ä¸Šä¼ æµ‹è¯•**: ä¸Šä¼ å›¾ç‰‡å¹¶è¯¢é—®ç›¸å…³é—®é¢˜
4. **è¿æ¥æµ‹è¯•**: æµ‹è¯•AIè®¾ç½®éªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### é¢„æœŸæ”¹è¿›:
- âœ… ç”¨æˆ·å¯ä»¥ä½¿ç”¨è‡ªå·±çš„API Key
- âœ… å¯ä»¥åˆ‡æ¢ä¸åŒçš„AIæ¨¡å‹ï¼ˆGPT-4ã€Claudeã€Geminiç­‰ï¼‰
- âœ… AIå›å¤è´¨é‡æå‡ï¼ˆæœ‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼‰
- âœ… å›¾ç‰‡å¤„ç†æ›´ç¨³å®š
- âœ… è®¾ç½®éªŒè¯æ›´å‡†ç¡®

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### åç«¯å…¼å®¹æ€§:
- åç«¯éœ€è¦æ”¯æŒæ–°çš„APIæ ¼å¼
- éœ€è¦å¤„ç†`messages`å’Œ`ai_settings`å‚æ•°
- ç¡®ä¿`/api/test-ai-model`ç«¯ç‚¹æ­£å¸¸å·¥ä½œ

### ç”¨æˆ·ä½“éªŒ:
- é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½®AIè®¾ç½®
- é”™è¯¯æç¤ºæ›´å‡†ç¡®å’Œå‹å¥½
- ä¿æŒå‘åå…¼å®¹æ€§

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **é”™è¯¯å¤„ç†**: è¿›ä¸€æ­¥å®Œå–„å„ç§é”™è¯¯æƒ…å†µçš„å¤„ç†
2. **æ€§èƒ½ä¼˜åŒ–**: å¤§å‹å¯¹è¯å†å²çš„å‹ç¼©å’Œä¼˜åŒ–
3. **å®‰å…¨æ€§**: API Keyçš„å®‰å…¨å­˜å‚¨å’Œä¼ è¾“
4. **ç”¨æˆ·ä½“éªŒ**: æ›´å¥½çš„åŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º 